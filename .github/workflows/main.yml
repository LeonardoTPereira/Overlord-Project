name: Actions

on:
  pull_request:
    branches:
      - main
      - develop

env:
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

jobs:   
    sonarcloud:
        name: Sonar Cloud Validation
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v2
          with:
            fetch-depth: 0
        - name: SonarCloud Scan
          uses: sonarsource/sonarcloud-github-action@master
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    testRunner:
        needs: sonarcloud
        name: Test in ${{ matrix.testMode }} ‚ú®
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                testMode:
                  - EditMode
                  - PlayMode
        steps:
            - name: Checkout code
              uses: actions/checkout@v2
              
            - name: Restore Library cache
              uses: actions/cache@v2
              with:
                path: Library
                key: Library-test-project-${{ matrix.targetPlatform }}
                restore-keys: |
                    Library-test-project-
                    Library-
                    
            - uses: game-ci/unity-test-runner@v2.0-alpha-5
              id: testRunner
              with:
                testMode: ${{ matrix.testMode }}
                checkName: ${{ matrix.testMode }} test results
                githubToken: ${{ secrets.GITHUB_TOKEN }}

            - uses: actions/upload-artifact@v2
              with:
                name: Test results (${{ matrix.testMode }})
                path: ${{ steps.testRunner.outputs.artifactsPath }}

    buildWebGL:
        needs: testRunner
        name: Build for WebGL üñ•Ô∏è
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
        steps:
          - name: Checkout code
            uses: actions/checkout@v2

          - name: Restore Library cache
            uses: actions/cache@v2
            with:
              path: Library
              key: Library-build-WebGL
              restore-keys: |
                Library-build-
                Library-
          - uses: game-ci/unity-builder@v2
            with:
              targetPlatform: WebGL

          - uses: actions/upload-artifact@v2
            with:
              name: build-WebGL
              path: build/WebGL

          # Output
          - uses: actions/upload-artifact@v2
            with:
              name: Build
              path: build

    deployPages:
        needs: buildWebGL
        name: Deploy to Github Pages üöÄ
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - uses: actions/download-artifact@v2
              with:
                name: build-WebGL
                path: build

            - name: Deploy üöÄ
              uses: JamesIves/github-pages-deploy-action@4.1.4
              with:
                branch: gh-pages
                folder: build/WebGL